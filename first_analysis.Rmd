r ---
title: "Analysis"
author: "Alicia Canales"
date: "2023-05-04"
output: 
  html_document:
    code_folding: 'hide'
---

```{r setup, include=FALSE, message=FALSE, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE, results=FALSE, message=FALSE)
# removed "include" to plot figues on the Markdown
```

```{r}
library(tidyverse)
library(here)
library(janitor)
library(readxl)
library(tsibble)
library(lubridate)
library(feasts)
library(patchwork)
library(kableExtra)
library(purrr)
library(PerformanceAnalytics)
```

### Importing data **this is only the first page of the excel sheet**
```{r}
coho <- readxl::read_xlsx(here('data', 'OC Coho Abundance.xlsx')) %>% #,skip = 1, col_names = TRUE) %>%
  clean_names() %>% 
  distinct()

coho_1 <- readxl::read_xlsx(here('data', 'wil_coho_harvest_estimates.xlsx')) %>%
  clean_names()

coho_2 <- readxl::read_xlsx(here('data', 'wild_spawner_abundance.xlsx')) %>%
  clean_names()


## changing the names of the columns
#colnames(coho) <- coho[1,] #Removed first column of data set so don't think this for now (I think - Olivia)

## making things more tidy
clean_coho <- coho[-1,] %>% 
  clean_names() %>% 
  pivot_longer('alsea':'yaquina',
               names_to = 'name',
               values_to = 'count')
```


```{r}
# plot 21 time series. 4 x 5 panels. This would be for trends
# calculate returns --> we the need to plot this and see if there is an absensce of trend or not
# x axis is time y axis is return calculation
# mean over time 

# verify that there are duplicates
# variance of Returns
# calculate covariance --> there should just be a function for this. maybe find a way to put the whole matrix in the function


```


# Create figures of each population from 1994-2019
```{r}
coho_yr <- coho %>%
  mutate(date = lubridate::mdy(year)) #Convert to date for tibble

coho_ts <- coho_yr %>%
 as_tsibble(key = NULL, index = year) #Convert to tibble for timeseries

pop_alsea <- ggplot(data = coho_ts, aes(x = year, y = alsea)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Alsea") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_beaver <- ggplot(data = coho_ts, aes(x = year, y = beaver)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Beaver") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_coos <- ggplot(data = coho_ts, aes(x = year, y = coos)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Coos") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_coquille <- ggplot(data = coho_ts, aes(x = year, y = coquille)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Coquille") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_floras <- ggplot(data = coho_ts, aes(x = year, y = floras)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Floras") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_lower_umpqua <- ggplot(data = coho_ts, aes(x = year, y = lower_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Lower Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_middle_umpqua <- ggplot(data = coho_ts, aes(x = year, y = middle_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Middle Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_necanicum <- ggplot(data = coho_ts, aes(x = year, y = necanicum)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Necanicum") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_nehalem <- ggplot(data = coho_ts, aes(x = year, y = nehalem)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Mehalem") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_nestucca <- ggplot(data = coho_ts, aes(x = year, y = nestucca)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Nestucca") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_north_umpqua <- ggplot(data = coho_ts, aes(x = year, y = north_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "North Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_salmon <- ggplot(data = coho_ts, aes(x = year, y = salmon)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Salmon") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_siletz <- ggplot(data = coho_ts, aes(x = year, y = siletz)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Siletz") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_siltcoos <- ggplot(data = coho_ts, aes(x = year, y = siltcoos)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Siltcoos") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_siuslaw <- ggplot(data = coho_ts, aes(x = year, y = siuslaw)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Siuslaw") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_sixes <- ggplot(data = coho_ts, aes(x = year, y = sixes)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Sixes") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_south_umpqua <- ggplot(data = coho_ts, aes(x = year, y = south_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "South Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_tahkenitch <- ggplot(data = coho_ts, aes(x = year, y = tahkenitch)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Tahkenitch") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_tenmile <- ggplot(data = coho_ts, aes(x = year, y = tenmile)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Tenmile") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_tillamook <- ggplot(data = coho_ts, aes(x = year, y = tillamook)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Tillamook") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

pop_yaquina <- ggplot(data = coho_ts, aes(x = year, y = yaquina)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Population Count",
      title = "Yaquina") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


#pop_alsea
#pop_beaver
#pop_coos
#pop_coquille
#pop_floras
#pop_lower_umpqua
#pop_middle_umpqua
#pop_necanicum
#pop_nehalem
#pop_nestucca
#pop_north_umpqua
#pop_salmon
#pop_siletz
#pop_siltcoos
#pop_siuslaw
#pop_sixes
#pop_south_umpqua
#pop_tahkenitch
#pop_tenmile
#pop_tillamook
#pop_yaquina
```

#Panel of figures of Y(it) - Annual population for each independent population
```{r}
patchwork::plot_layout(pop_alsea + pop_beaver + pop_coos + pop_coquille)

patchwork::plot_layout(pop_floras + pop_lower_umpqua + pop_middle_umpqua + pop_necanicum)

patchwork::plot_layout(pop_nehalem + pop_nestucca + pop_north_umpqua + pop_salmon)

patchwork::plot_layout(pop_siletz + pop_siltcoos + pop_siuslaw + pop_sixes)

patchwork::plot_layout(pop_south_umpqua + pop_tahkenitch + pop_tenmile + pop_tillamook)

patchwork::plot_layout(pop_yaquina)
```


#Calculate sample means of each population
```{r}
#This is more concise in the next code chunk, but I thought I would leave this here in case we don't want to use the sapply function.

sample_means <- colMeans(coho)

kable(sample_means, format = "markdown", digits = 3,caption = "**Sample Means**")
```

# Calculate Mean, Variance, SD
```{r}
#Just learned about the sapply function and it is SO COOL. #When I compare these mean/var/sd to those that I manually calculated in excel, they don't match. Can someone check this? Thanks! - Olivia 
## Did you make sure you took out the duplicates in the excel sheet? Cause I only took them out in R. I just checked in excel and they match!!

pop_mean <- sapply(coho[2:22], mean)
pop_variance <- sapply(coho[2:22], var)
pop_sd <- sapply(coho[2:22], sd)

# data check
mean(coho$alsea)
var(coho$alsea)
sd(coho$alsea)
cov(coho$alsea, coho$beaver)

df1 <- data.frame(pop_mean, pop_variance, pop_sd) #combine data into one data frame

#Plot table
table_df1 <- df1 %>% 
  kable(col.names = c("Mean", "Variance", "Standard Deviation")) %>% 
  kable_styling(bootstrap_options = "striped",
                position = "left", full_width = FALSE)

table_df1

## In case we need to get the variance of a population (instead of a sample):
# var_pop <- function(x) {
#   mean((x-mean(x))^2)
# }

# var_pop(coho$alsea)
```


# Calculate covariance of each return
```{r, results = TRUE}
#Calculate covariance
pop_cov <- cov(coho[2:22])

# pop_cov

# Only show bottom triangle of covariances
upper<-pop_cov
upper[upper.tri(pop_cov)] <-""
upper<-as.data.frame(upper)
upper

```


# Calculating R(it) -- Returns
```{r}
# return <- function(x0, x1){
#   rt = x0/x1 - 1
#   return(rt)
# } 
## in this case x0 is our Yit-1 or the year after the initial year and x1 is our Yit or the initial year

calculate_returns <- function(data) {
  rt <- numeric(length(data) - 1)  
  for (i in 2:length(data)) {
    rt[i-1] <- (data[i-1] / data[i]) - 1
  }
  return(rt)
} # i-1 is the current population for whatever year we are looking at and i is the initial population from the previous year

returns <- data.frame(apply(coho[2:22], 2, calculate_returns))

```


# Calculation for mean, sd, variance -- returns
```{r}
# calculation for returns
return_mean <- sapply(returns, mean)
return_variance <- sapply(returns, var)
return_sd <- sapply(returns, sd)
df2 <- data.frame(return_mean, return_variance, return_sd)

```

# Calculation for covariance -- returns
```{r, results = TRUE}
#Calculate covariance
return_cov <- cov(returns)

# pop_cov

# Only show bottom triangle of covariances
upper<-return_cov
upper[upper.tri(return_cov)] <-""
upper<-as.data.frame(upper)
upper

return_cov
```

# Plotting R(it) -- Returns
```{r}
# combining date column to new returns df
returns_yr<- cbind(returns, coho_yr$year[-1]) %>% 
  rename('year' = 'coho_yr$year[-1]')

return_ts <- returns_yr %>%
 as_tsibble(key = NULL, index = year)

rt_alsea <- ggplot(data = return_ts, aes(x = year, y = alsea)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Alsea") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_beaver <- ggplot(data = return_ts, aes(x = year, y = beaver)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Beaver") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_coos <- ggplot(data = return_ts, aes(x = year, y = coos)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Coos") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_coquille <- ggplot(data = return_ts, aes(x = year, y = coquille)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Coquille") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_floras <- ggplot(data = return_ts, aes(x = year, y = floras)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Floras") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_lower_umpqua <- ggplot(data = return_ts, aes(x = year, y = lower_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Lower Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_middle_umpqua <- ggplot(data = return_ts, aes(x = year, y = middle_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Middle Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_necanicum <- ggplot(data = return_ts, aes(x = year, y = necanicum)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Necanicum") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_nehalem <- ggplot(data = return_ts, aes(x = year, y = nehalem)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Mehalem") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_nestucca <- ggplot(data = return_ts, aes(x = year, y = nestucca)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Nestucca") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_north_umpqua <- ggplot(data = return_ts, aes(x = year, y = north_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "North Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_salmon <- ggplot(data = return_ts, aes(x = year, y = salmon)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Salmon") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_siletz <- ggplot(data = return_ts, aes(x = year, y = siletz)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Siletz") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_siltcoos <- ggplot(data = return_ts, aes(x = year, y = siltcoos)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Siltcoos") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_siuslaw <- ggplot(data = return_ts, aes(x = year, y = siuslaw)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Siuslaw") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_sixes <- ggplot(data = return_ts, aes(x = year, y = sixes)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Sixes") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_south_umpqua <- ggplot(data = return_ts, aes(x = year, y = south_umpqua)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "South Umpqua") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_tahkenitch <- ggplot(data = return_ts, aes(x = year, y = tahkenitch)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Tahkenitch") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_tenmile <- ggplot(data = return_ts, aes(x = year, y = tenmile)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Tenmile") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_tillamook <- ggplot(data = return_ts, aes(x = year, y = tillamook)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Tillamook") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

rt_yaquina <- ggplot(data = return_ts, aes(x = year, y = yaquina)) +
  geom_line(color = "#453781FF") +
  scale_x_continuous(breaks=seq(1994, 2019, by = 1)) +
  labs(x = "Year",
      y = "Return",
      title = "Yaquina") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```



#Panel of figures of R(it) - Annual returns for each independent population
```{r}
patchwork::plot_layout(rt_alsea + rt_beaver + rt_coos + rt_coquille)

patchwork::plot_layout(rt_floras + rt_lower_umpqua + rt_middle_umpqua + rt_necanicum)

patchwork::plot_layout(rt_nehalem + rt_nestucca + rt_north_umpqua + rt_salmon)

patchwork::plot_layout(rt_siletz + rt_siltcoos + rt_siuslaw + rt_sixes)

patchwork::plot_layout(rt_south_umpqua + rt_tahkenitch + rt_tenmile + rt_tillamook)

patchwork::plot_layout(rt_yaquina)
```



















